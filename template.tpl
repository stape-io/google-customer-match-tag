___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Google Customer Match by Stape",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Use this tag to upload your Customer Match lists and send audience data to Google\u0027s advertising products through the Data Manager API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "audienceAction",
    "displayName": "Action",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "ingest",
        "displayValue": "Add to Customer List"
      },
      {
        "value": "remove",
        "displayValue": "Remove from Customer List"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "RADIO",
    "name": "authFlow",
    "displayName": "Authentication Type",
    "radioItems": [
      {
        "value": "stape",
        "displayValue": "Stape Google Connection",
        "help": "You can enable it on the Stape container settings, in the \u003ca href\u003d\"https://app.stape.io/container/\" target\u003d\"_blank\"\u003eConnections\u003c/a\u003e section.\n\u003c/br\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://stape.io/blog/google-ads-offline-conversion-using-server-gtm\" target\u003d\"_blank\"\u003eLearn more in this Stape article.\u003c/a\u003e",
        "subParams": []
      }
    ],
    "simpleValueType": true,
    "defaultValue": "stape"
  },
  {
    "type": "GROUP",
    "name": "destinationsGroup",
    "displayName": "",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "stapeAuthDestinationsList",
        "displayName": "Destination Accounts and Customer Lists",
        "simpleTableColumns": [
          {
            "defaultValue": "GOOGLE_ADS",
            "displayName": "Product",
            "name": "product",
            "type": "SELECT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "GOOGLE_ADS",
                "displayValue": "Google Ads"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Operating Customer ID",
            "name": "operatingAccountId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Customer ID",
            "name": "linkedAccountId",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ],
            "valueHint": "1234567890"
          },
          {
            "defaultValue": "",
            "displayName": "Customer List Name",
            "name": "productDestinationId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "authFlow",
            "paramValue": "stape",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "newRowButtonText": "Add Customer List",
        "help": "\u003cb\u003eProduct\u003c/b\u003e: The Product the Customer List belongs to.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eOperating Customer ID\u003c/b\u003e: The \u003ci\u003eAccount ID\u003c/i\u003e (without hyphens) of the account (Google Ads account, DV360 account etc.) that will receive customer list data. \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/Destination\"\u003eLearn more\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eCustomer ID\u003c/b\u003e: The \u003ci\u003eAccount ID\u003c/i\u003e (without hyphens) of the account for which the link between the Data Partner account (Stape) and the Advertiser account was established.\n\u003cbr/\u003e\ne.g. the link between the Data Partner account (Stape) and Advertiser account can be done at MCC level, but the data is going to be sent to a subaccount of the MCC.\n\u003cbr/\u003e\nIn this case: the Customer Account is the MCC, and Operating Customer Account is the subaccount.\n\u003cbr/\u003e\nIf the link is done with the same account that will receive the data, then the Customer Account and Operating Customer Account are the same.\n\u003cbr/\u003e\n\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/Destination\"\u003eLearn more\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eCustomer List Name\u003c/b\u003e: The name of the customer list you want to interact with.\n\u003cbr/\u003e\nOnly customer lists created through the Stape connection are supported. You cannot interact with arbitrary customer lists.\n\u003cbr/\u003e\nWhen using Google products, the audience will appear with the name format: \u003ci\u003estape_\u0026lt;Customer List Name\u0026gt;\u003c/i\u003e. This customer list is created automatically by Stape during the integration process.\n\u003cbr/\u003e\nFor example, if you enter \"Purchasers\" in this field, the tag will interact with the customer list named \u003ci\u003estape_Purchasers\u003c/i\u003e in your Google product."
      }
    ],
    "groupStyle": "NO_ZIPPY"
  },
  {
    "type": "SELECT",
    "name": "termsOfServiceStatus",
    "displayName": "Terms of Service Status",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "ACCEPTED",
        "displayValue": "ACCEPTED"
      },
      {
        "value": "REJECTED",
        "displayValue": "REJECTED"
      }
    ],
    "simpleValueType": true,
    "notSetText": "(not set)",
    "help": "\u003ca href\u003d\"https://support.google.com/adspolicy/answer/6299717\"\u003eThe Customer Match terms of service\u003c/a\u003e.\n\u003cbr/\u003e\nThis must be accepted for all uploads to Customer Match user lists.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "audienceAction",
        "paramValue": "ingest",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "validateOnly",
    "displayName": "Validate Only",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "help": "If \u003cb\u003etrue\u003c/b\u003e, the request is validated but not executed. Only errors are returned, not results.\u003cbr /\u003e \u003ca href\u003d\"https://developers.google.com/google-ads/api/rest/reference/rest/v17/customers/uploadClickConversions?hl\u003den#request-body\"\u003eRead more\u003c/a\u003e.",
    "defaultValue": false
  },
  {
    "type": "SELECT",
    "name": "useOptimisticScenario",
    "displayName": "Use Optimistic Scenario",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
    "defaultValue": false
  },
  {
    "type": "GROUP",
    "name": "requestLevelConsentGroup",
    "displayName": "Request-level Consent",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "requestLevelConsentGroupLabel",
        "displayName": "Request-level consent to apply to all users in the request.\n\u003cbr/\u003e\nUser-level consent overrides request-level consent, and can be specified for each audience member when sending data to \u003ci\u003eMultiple Users\u003c/i\u003e in the \u003cb\u003eAudience Members\u003c/b\u003e section."
      },
      {
        "type": "SELECT",
        "name": "adUserData",
        "displayName": "Consent for Ad User Data",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "CONSENT_GRANTED",
            "displayValue": "CONSENT_GRANTED"
          },
          {
            "value": "CONSENT_DENIED",
            "displayValue": "CONSENT_DENIED"
          },
          {
            "value": "CONSENT_STATUS_UNSPECIFIED",
            "displayValue": "CONSENT_STATUS_UNSPECIFIED"
          }
        ],
        "simpleValueType": true,
        "help": "This represents consent to Ad User Data.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "adPersonalization",
        "displayName": "Consent for Ad Personalization",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "CONSENT_GRANTED",
            "displayValue": "CONSENT_GRANTED"
          },
          {
            "value": "CONSENT_DENIED",
            "displayValue": "CONSENT_DENIED"
          },
          {
            "value": "CONSENT_STATUS_UNSPECIFIED",
            "displayValue": "CONSENT_STATUS_UNSPECIFIED"
          }
        ],
        "simpleValueType": true,
        "help": "This represents consent to Ad Personalization.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "audienceAction",
        "paramValue": "ingest",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "audienceMembersGroup",
    "displayName": "Audience Members",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "audienceDataEncoding",
        "displayName": "Audience Data Encoding",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "HEX",
            "displayValue": "HEX"
          },
          {
            "value": "BASE64",
            "displayValue": "BASE64"
          }
        ],
        "simpleValueType": true,
        "help": "The encoding type of the user identifiers SHA256 hash: \u003ci\u003eHEX\u003c/i\u003e or \u003ci\u003eBASE64\u003c/i\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eRequired\u003c/b\u003e for \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/UserData\"\u003e\u003ci\u003eUserData\u003c/i\u003e\u003c/a\u003e (User Email Address, User Phone Number and User Given/Family Name) uploads.\n\u003cbr/\u003e\nFor other types (User Address Region and User Address Postal Code) uploads, this field is \u003cb\u003eignored\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nFor hashed user identifiers, this is the encoding type of the hashed string. For encrypted hashed user identifiers, this is the encoding type of the outer encrypted string, but not necessarily the inner hashed string, meaning the inner hashed string could be encoded in a different way than the outer encrypted string.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eDefault\u003c/b\u003e: \u003ci\u003eHEX\u003c/i\u003e - when passing a non-hashed value to \u003ci\u003eUserData\u003c/i\u003e (User Email Address, User Phone Number and User Given/Family Name) fields; or when using default values from GA4 Event Data.",
        "notSetText": "(not set)"
      },
      {
        "type": "SELECT",
        "name": "enableAudienceDataEncryption",
        "displayName": "Audience Data Encryption",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "false"
          },
          {
            "value": true,
            "displayValue": "true"
          }
        ],
        "simpleValueType": true,
        "help": "Encryption information for \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/UserData\"\u003e\u003ci\u003eUserData\u003c/i\u003e\u003c/a\u003e (User Email Address, User Phone Number and User Given/Family Name) uploads.\n\u003cbr/\u003e\u003cbr/\u003e\nIf not set, it\u0027s assumed that uploaded identifying information is hashed but not encrypted.\n\u003cbr/\u003e\u003cbr/\u003e \nFor other types (User Address Region and User Address Postal Code) uploads, this field is \u003cb\u003eignored\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nReferences:  \n\u003cul\u003e \n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/encryption\"\u003eData Manager API: Getting started with Encryption\u003c/a\u003e\u003c/li\u003e \u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/EncryptionInfo\"\u003eEncryptionInfo object\u003c/a\u003e\u003c/li\u003e \u003c/ul\u003e",
        "defaultValue": false,
        "subParams": [
          {
            "type": "GROUP",
            "name": "audienceDataEncryptionInfoGroup",
            "displayName": "Encryption Info (Google Cloud Platform wrapped key information)",
            "groupStyle": "ZIPPY_OPEN_ON_PARAM",
            "subParams": [
              {
                "type": "SELECT",
                "name": "gcpWrappedKeyType",
                "displayName": "Key Type",
                "macrosInSelect": false,
                "selectItems": [
                  {
                    "value": "XCHACHA20_POLY1305",
                    "displayValue": "XCHACHA20_POLY1305"
                  }
                ],
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "The type of algorithm used to encrypt the data."
              },
              {
                "type": "TEXT",
                "name": "gcpWrappedKeyWipProvider",
                "displayName": "Workload Identity pool provider",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "The \u003ca href\u003d\"https://cloud.google.com/iam/docs/workload-identity-federation\"\u003eWorkload Identity\u003c/a\u003e pool provider required to use KEK."
              },
              {
                "type": "TEXT",
                "name": "gcpWrappedKeyKekUri",
                "displayName": "Google Cloud Platform Cloud Key Management Service resource ID",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "The Google Cloud Platform \u003ca href\u003d\"https://cloud.google.com/kms/docs/getting-resource-ids\"\u003eCloud Key Management Service resource ID\u003c/a\u003e."
              },
              {
                "type": "TEXT",
                "name": "gcpWrappedKeyEncryptedDek",
                "displayName": "Encrypted data encryption key",
                "simpleValueType": true,
                "help": "The base64 encoded encrypted data encryption key.",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "enableAudienceDataEncryption",
                "paramValue": false,
                "type": "NOT_EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "userMode",
        "displayName": "User Mode",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "single",
            "displayValue": "Single User"
          },
          {
            "value": "multiple",
            "displayValue": "Multiple Users"
          }
        ],
        "simpleValueType": true,
        "help": "Send data for a single user or for multiple users."
      },
      {
        "type": "GROUP",
        "name": "audienceMembersSingleUserGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "GROUP",
            "name": "userDataGroup",
            "displayName": "User Data Identifiers",
            "groupStyle": "ZIPPY_OPEN",
            "subParams": [
              {
                "type": "LABEL",
                "name": "userDataGroupLabel",
                "displayName": "When sending User Data Identifiers, \u003cb\u003eat least one\u003c/b\u003e of User Email Address(es), User Phone Number(s) or User Address must be specified.\n\u003cbr/\u003e\nThe total number of User Data identifiers must not exceed 10 items."
              },
              {
                "type": "TEXT",
                "name": "userDataEmailAddresses",
                "displayName": "User Email Address(es)",
                "simpleValueType": true,
                "help": "Specify a single email address, or an array of email addresses. Each item can be already SHA256 hashed or not. They can be already encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.user_data.email\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.email_address\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.sha256_email\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.sha256_email_address\u003c/i\u003e\n\u003cbr/\u003e\n⚠️ If you do NOT want to use the default value, pass an \u003ci\u003eundefined\u003c/i\u003e variable in the field (not the \"undefined\" string).",
                "valueHint": "jane@example.com"
              },
              {
                "type": "TEXT",
                "name": "userDataPhoneNumbers",
                "displayName": "User Phone Number(s)",
                "simpleValueType": true,
                "help": "Specify a single phone number, or an array of phone numbers. Each item can be already SHA256 hashed or not. They can be already encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nUse \u003ca href\u003d\"https://en.wikipedia.org/wiki/E.164\"\u003eE.164 format\u003c/a\u003e. Include the plus sign (+) and the country code.\n\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.user_data.phone\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.phone_number\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.sha256_phone_number\u003c/i\u003e\n\u003cbr/\u003e\n⚠️ If you do NOT want to use the default value, pass an \u003ci\u003eundefined\u003c/i\u003e variable in the field (not the \"undefined\" string).",
                "valueHint": "+1555999999999"
              },
              {
                "type": "CHECKBOX",
                "name": "addUserDataAddress",
                "checkboxText": "Add User Address data",
                "simpleValueType": true,
                "subParams": [
                  {
                    "type": "GROUP",
                    "name": "userDataAddressGroup",
                    "subParams": [
                      {
                        "type": "LABEL",
                        "name": "userDataAddressLabel",
                        "displayName": "You must specify \u003cb\u003eall\u003c/b\u003e the fields below (User Given Name, User Family Name, User Address Region and User Address Postal Code)."
                      },
                      {
                        "type": "TEXT",
                        "name": "addressGivenName",
                        "displayName": "User Given Name",
                        "simpleValueType": true,
                        "help": "Specify the User Given Name (First Name). Don\u0027t include suffixes such as \u003ci\u003eJr\u003c/i\u003e. It can be already SHA256 hashed or not. It can be encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.user_data.address.first_name\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.address.sha256_first_name\u003c/i\u003e\n\u003cbr/\u003e\n⚠️ If you do NOT want to use the default value, pass an \u003ci\u003eundefined\u003c/i\u003e variable in the field (not the \"undefined\" string).",
                        "valueHint": "john",
                        "valueValidators": []
                      },
                      {
                        "type": "TEXT",
                        "name": "addressFamilyName",
                        "displayName": "User Family Name",
                        "simpleValueType": true,
                        "help": "Specify the User Family Name (Last Name). It can be already SHA256 hashed or not. It can be encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.user_data.address.last_name\u003c/i\u003e -\u003e \u003ci\u003eeventData.user_data.address.sha256_last_name\u003c/i\u003e\n\u003cbr/\u003e\n⚠️ If you do NOT want to use the default value, pass an \u003ci\u003eundefined\u003c/i\u003e variable in the field (not the \"undefined\" string).",
                        "valueHint": "doe",
                        "valueValidators": []
                      },
                      {
                        "type": "TEXT",
                        "name": "addressRegion",
                        "displayName": "User Address Region",
                        "simpleValueType": true,
                        "help": "The 2-letter region code in \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2\"\u003eISO-3166-1 alpha-2\u003c/a\u003e of the user\u0027s address. Do not hash.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.user_data.address.country\u003c/i\u003e\n\u003cbr/\u003e\n⚠️ If you do NOT want to use the default value, pass an \u003ci\u003eundefined\u003c/i\u003e variable in the field (not the \"undefined\" string).",
                        "valueHint": "US",
                        "valueValidators": []
                      },
                      {
                        "type": "TEXT",
                        "name": "addressPostalCode",
                        "displayName": "User Address Postal Code",
                        "simpleValueType": true,
                        "help": "The postal code of the user\u0027s address. Do not hash.\n\u003cbr/\u003e\nBoth US and international zip and postal codes are allowed. \n\u003cbr/\u003e\nFor US addresses, use either 5 digits or 5 digits followed by a 4-digit extension. Using a 4-digit extension may improve your match rate.\n\u003cbr/\u003e\nFor all other countries, don\u0027t use postal code extensions.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.user_data.address.postal_code\u003c/i\u003e\n\u003cbr/\u003e\n⚠️ If you do NOT want to use the default value, pass an \u003ci\u003eundefined\u003c/i\u003e variable in the field (not the \"undefined\" string).",
                        "valueHint": "10001",
                        "valueValidators": []
                      }
                    ],
                    "enablingConditions": [
                      {
                        "paramName": "addUserDataAddress",
                        "paramValue": true,
                        "type": "EQUALS"
                      }
                    ],
                    "groupStyle": "NO_ZIPPY"
                  }
                ]
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userMode",
            "paramValue": "single",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "audienceMembersMultipleUsersGroup",
        "subParams": [
          {
            "type": "TEXT",
            "name": "audienceMembers",
            "displayName": "Audience Members Array",
            "simpleValueType": true,
            "help": "Specify the Audience Members array. This is useful when you need to upload data for multiple users at once. At most\n10000 Audience Members can be specified in the array.\n\u003cbr/\u003e\u003cbr/\u003e\nThe only current supported type of user identifier is \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/UserData\"\u003e\u003ci\u003eUserData\u003c/i\u003e\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nThe array must be formatted as specified in the\nGoogle Documentation. You cam specify different consent types for each users, overriding the request-level consent.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eIf you already pass SHA256 hashed fields to the array, make sure to specify the SHA256 hash encoding in the corresponding template field. Otherwise, the tag will hash it automatically and set it for you.\u003c/b\u003e\n\u003cbr/\u003e\u003cbr/\u003e\nReferences: \n\u003cul\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/AudienceMember\"\u003eAudience Member\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting\"\u003eNormalization guidelines\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/quickstart/send-audience-members?persona\u003dadvertiser#build_the_request_body\"\u003eExample\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userMode",
            "paramValue": "multiple",
            "type": "EQUALS"
          }
        ],
        "groupStyle": "NO_ZIPPY"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettingsGroup",
    "displayName": "Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr\u003e\u003cbr\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeString = require('makeString');
const Object = require('Object');
const sendHttpRequest = require('sendHttpRequest');
const sha256Sync = require('sha256Sync');

/*==============================================================================
==============================================================================*/

const traceId = getRequestHeader('trace-id');

const eventData = getAllEventData();

const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

if (!isConsentGivenOrNotRequired()) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const mappedData = getDataForAudienceDataUpload(data, eventData);

const invalidFields = validateMappedData(mappedData);
if (invalidFields) {
  log({
    Name: 'GoogleCustomerMatch',
    Type: 'Message',
    TraceId: traceId,
    EventName:
      data.audienceAction +
      ' | Audience ID(s): ' +
      mappedData.destinations.map((d) => d.productDestinationId).join(','),
    Message: 'Request was not sent.',
    Reason: invalidFields
  });

  return data.gtmOnFailure();
}

sendRequest(data, mappedData);

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function addDestinationsData(data, mappedData) {
  const destinations = [];
  const accountsAndDestinationsFromUI = data.stapeAuthDestinationsList;

  accountsAndDestinationsFromUI.forEach((row) => {
    const destination = {
      productDestinationId: 'stape_' + makeString(row.productDestinationId).trim(),
      operatingAccount: {
        product: row.product,
        accountId: makeString(row.operatingAccountId)
      }
    };

    if (data.authFlow === 'stape' && row.linkedAccountId) {
      destination.linkedAccount = {
        product: row.product,
        accountId: makeString(row.linkedAccountId)
      };
    }

    destinations.push(destination);
  });

  mappedData.destinations = destinations;

  return mappedData;
}

function addTermsOfService(data, mappedData) {
  const termsOfService = {
    customerMatchTermsOfServiceStatus: data.termsOfServiceStatus
  };

  mappedData.termsOfService = termsOfService;

  return mappedData;
}

function addConsentData(data, mappedData) {
  const consent = {};
  const consentTypes = ['adUserData', 'adPersonalization'];

  consentTypes.forEach((consentType) => {
    if (!data[consentType]) return;
    consent[consentType] = data[consentType];
    mappedData.consent = consent;
  });

  return mappedData;
}

function getEmailAddressesFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};

  let email =
    eventDataUserData.email ||
    eventDataUserData.email_address ||
    eventDataUserData.sha256_email ||
    eventDataUserData.sha256_email_address;

  const emailType = getType(email);

  if (emailType === 'string') email = [email];
  else if (emailType === 'array') email = email.length > 0 ? email : undefined;
  else if (emailType === 'object') {
    const emailsFromObject = Object.values(email);
    if (emailsFromObject.length) email = emailsFromObject;
  }

  return email;
}

function getPhoneNumbersFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};

  let phone =
    eventDataUserData.phone ||
    eventDataUserData.phone_number ||
    eventDataUserData.sha256_phone_number;

  const phoneType = getType(phone);

  if (phoneType === 'string') phone = [phone];
  else if (phoneType === 'array') phone = phone.length > 0 ? phone : undefined;
  else if (phoneType === 'object') {
    const phonesFromObject = Object.values(phone);
    if (phonesFromObject.length) phone = phonesFromObject;
  }

  return phone;
}

function getAddressFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};
  let eventDataUserDataAddress = {};
  const addressType = getType(eventDataUserData.address);
  if (addressType === 'object' || addressType === 'array') {
    eventDataUserDataAddress = eventDataUserData.address[0] || eventDataUserData.address;
  }

  const firstName =
    eventDataUserDataAddress.first_name || eventDataUserDataAddress.sha256_first_name;
  const lastName = eventDataUserDataAddress.last_name || eventDataUserDataAddress.sha256_last_name;
  const postalCode = eventDataUserDataAddress.postal_code;
  const regionCode = eventDataUserDataAddress.country;

  if (firstName && lastName && postalCode && regionCode) {
    return {
      givenName: makeString(firstName),
      familyName: makeString(lastName),
      postalCode: makeString(postalCode),
      regionCode: makeString(regionCode)
    };
  }
}

function addAudienceMembersData(data, eventData, mappedData) {
  const itemizeUserIdentifier = (input) => {
    const type = getType(input);
    if (type === 'array') return input.filter((e) => e);
    if (type === 'string' || type === 'number') return [input];
    return [];
  };
  const audienceMemberIDsLengthLimit = 10;

  let audienceMembers = [];

  if (data.userMode === 'single') {
    let emailAddresses = data.hasOwnProperty('userDataEmailAddresses')
      ? data.userDataEmailAddresses
      : getEmailAddressesFromEventData(eventData);

    let phoneNumbers = data.hasOwnProperty('userDataPhoneNumbers')
      ? data.userDataPhoneNumbers
      : getPhoneNumbersFromEventData(eventData);

    let address;
    if (data.addUserDataAddress) {
      const addressUIFields = [
        'addressGivenName',
        'addressFamilyName',
        'addressRegion',
        'addressPostalCode'
      ];

      const inputHasAllAddressFields = addressUIFields.every((p) => data.hasOwnProperty(p));
      if (inputHasAllAddressFields) {
        const inputAllAddressFieldsAreValid = addressUIFields.every((p) => isValidValue(data[p]));
        if (inputAllAddressFieldsAreValid) {
          address = {
            givenName: makeString(data.addressGivenName),
            familyName: makeString(data.addressFamilyName),
            regionCode: makeString(data.addressRegion),
            postalCode: makeString(data.addressPostalCode)
          };
        }
      } else {
        address = getAddressFromEventData(eventData);
      }
    }

    if (emailAddresses || phoneNumbers || address) {
      const userIdentifiers = [];

      if (emailAddresses) {
        emailAddresses = itemizeUserIdentifier(emailAddresses);
        if (emailAddresses.length) {
          emailAddresses.forEach((email) => userIdentifiers.push({ emailAddress: email }));
        }
      }

      if (phoneNumbers) {
        phoneNumbers = itemizeUserIdentifier(phoneNumbers);
        if (phoneNumbers.length) {
          phoneNumbers.forEach((phone) => userIdentifiers.push({ phoneNumber: phone }));
        }
      }

      if (address) {
        userIdentifiers.push({
          address: address
        });
      }

      if (userIdentifiers && userIdentifiers.length) {
        audienceMembers.push({
          userData: {
            userIdentifiers: userIdentifiers.slice(0, audienceMemberIDsLengthLimit)
          }
        });
      }
    }

    if (data.mobileIds) {
      const mobileIds = itemizeUserIdentifier(data.mobileIds);
      if (mobileIds && mobileIds.length) {
        audienceMembers.push({
          mobileData: {
            mobileIds: mobileIds.slice(0, audienceMemberIDsLengthLimit)
          }
        });
      }
    }

    if (data.pairIds) {
      const pairIds = itemizeUserIdentifier(data.pairIds);
      if (pairIds && pairIds.length) {
        audienceMembers.push({
          pairData: {
            pairIds: pairIds.slice(0, audienceMemberIDsLengthLimit)
          }
        });
      }
    }
  } else if (data.userMode === 'multiple' && getType(data.audienceMembers) === 'array') {
    data.audienceMembers.forEach((audienceMember) => {
      if (!audienceMember || !audienceMember.userData) return;

      const audienceMemberUserDataOnly = {
        userData: audienceMember.userData
      };
      if (audienceMember.consent) audienceMemberUserDataOnly.consent = audienceMember.consent;
      audienceMembers.push(audienceMemberUserDataOnly);
    });
  }

  mappedData.audienceMembers = audienceMembers;

  return mappedData;
}

function addEncodingData(data, mappedData) {
  // Avoids overwriting the encoding information if the tag auto-hashed (HEX output) audience data.
  mappedData.encoding = mappedData.encoding || data.audienceDataEncoding;
  return mappedData;
}

function addEncryptionData(data, mappedData) {
  const encryptionInfo = {
    gcpWrappedKeyInfo: {
      keyType: data.gcpWrappedKeyType,
      wipProvider: data.gcpWrappedKeyWipProvider,
      kekUri: data.gcpWrappedKeyKekUri,
      encryptedDek: data.gcpWrappedKeyEncryptedDek
    }
  };

  mappedData.encryptionInfo = encryptionInfo;

  return mappedData;
}

function hashDataIfNeeded(mappedData) {
  const audienceMembers = mappedData.audienceMembers;

  if (audienceMembers) {
    audienceMembers.forEach((audienceMember) => {
      if (!audienceMember) return;

      if (
        audienceMember.userData &&
        audienceMember.userData.userIdentifiers &&
        getType(audienceMember.userData.userIdentifiers) === 'array'
      ) {
        audienceMember.userData.userIdentifiers.forEach((userIdentifier) => {
          const key = Object.keys(userIdentifier)[0];

          if (key === 'emailAddress' || key === 'phoneNumber') {
            let value = userIdentifier[key];
            if (isSHA256HexHashed(value)) {
              mappedData.encoding = 'HEX';
              return;
            } else if (isSHA256Base64Hashed(value)) {
              mappedData.encoding = 'BASE64';
              return;
            }

            if (key === 'phoneNumber') {
              value = value
                .split(' ')
                .join('')
                .split('-')
                .join('')
                .split('(')
                .join('')
                .split(')')
                .join('');
              if (value[0] !== '+') value = '+' + value;
            }

            userIdentifier[key] = hashData(value);
            mappedData.encoding = 'HEX';
          } else if (key === 'address') {
            const addressKeysToHash = ['givenName', 'familyName'];
            addressKeysToHash.forEach((nameKey) => {
              const value = userIdentifier.address[nameKey];
              if (!value) return;

              if (isSHA256HexHashed(value)) {
                mappedData.encoding = 'HEX';
                return;
              } else if (isSHA256Base64Hashed(value)) {
                mappedData.encoding = 'BASE64';
                return;
              }
              userIdentifier.address[nameKey] = hashData(value);
              mappedData.encoding = 'HEX';
            });
          }
        });
      } else if (
        audienceMember.pairData &&
        audienceMember.pairData.pairIds &&
        getType(audienceMember.pairData.pairIds) === 'array'
      ) {
        audienceMember.pairData.pairIds = audienceMember.pairData.pairIds.map((pairId) => {
          if (isSHA256HexHashed(pairId)) {
            mappedData.encoding = 'HEX';
            return pairId;
          } else if (isSHA256Base64Hashed(pairId)) {
            mappedData.encoding = 'BASE64';
            return pairId;
          }
          mappedData.encoding = 'HEX';
          return hashData(pairId);
        });
      }
    });
  }

  return mappedData;
}

function generateRequestUrl(data) {
  const audienceActionNormalization = {
    ingest: 'ingest',
    remove: 'remove'
  };
  const action = audienceActionNormalization[data.audienceAction];

  const containerIdentifier = getRequestHeader('x-gtm-identifier');
  const defaultDomain = getRequestHeader('x-gtm-default-domain');
  const containerApiKey = getRequestHeader('x-gtm-api-key');
  return (
    'https://' +
    enc(containerIdentifier) +
    '.' +
    enc(defaultDomain) +
    '/stape-api/' +
    enc(containerApiKey) +
    '/v2/data-manager/' +
    action
  );
}

function generateRequestOptions() {
  const options = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  };

  return options;
}

function validateMappedData(mappedData) {
  if (!mappedData.audienceMembers || mappedData.audienceMembers.length === 0) {
    return 'At least 1 Audience Member resource must be specified.';
  }

  const audienceMembersLengthLimit = 10000;
  if (mappedData.audienceMembers.length > audienceMembersLengthLimit) {
    return (
      'Audience Members list length must be at most ' +
      audienceMembersLengthLimit +
      '. Current is: ' +
      mappedData.audienceMembers.length
    );
  }

  const hasUserDataOrPairData = mappedData.audienceMembers.some((am) => am.userData || am.pairData);
  if (hasUserDataOrPairData && !mappedData.encoding) {
    return 'Encoding must be specified when sending UserData or PairData.';
  }
}

function getDataForAudienceDataUpload(data, eventData) {
  const mappedData = {
    validateOnly: isUIFieldTrue(data.validateOnly)
  };

  addDestinationsData(data, mappedData);
  if (data.audienceAction === 'ingest') {
    addTermsOfService(data, mappedData);
    addConsentData(data, mappedData);
  }
  addAudienceMembersData(data, eventData, mappedData);
  hashDataIfNeeded(mappedData); // This should come before addEncodingData().
  addEncodingData(data, mappedData);
  if (isUIFieldTrue(data.enableAudienceDataEncryption)) {
    addEncryptionData(data, mappedData);
  }

  return mappedData;
}

function sendRequest(data, mappedData) {
  const requestUrl = generateRequestUrl(data);
  const requestOptions = generateRequestOptions();
  const requestBody = mappedData;

  const logEventName =
    data.audienceAction +
    ' | Audience ID(s): ' +
    requestBody.destinations.map((d) => d.productDestinationId).join(',');

  log({
    Name: 'GoogleCustomerMatch',
    Type: 'Request',
    TraceId: traceId,
    EventName: logEventName,
    RequestMethod: 'POST',
    RequestUrl: requestUrl,
    RequestBody: requestBody
  });

  return sendHttpRequest(requestUrl, requestOptions, JSON.stringify(requestBody))
    .then((result) => {
      // .then has to be used when the Authorization header is in use
      log({
        Name: 'GoogleCustomerMatch',
        Type: 'Response',
        TraceId: traceId,
        EventName: logEventName,
        ResponseStatusCode: result.statusCode,
        ResponseHeaders: result.headers,
        ResponseBody: result.body
      });

      if (!useOptimisticScenario) {
        if (result.statusCode >= 200 && result.statusCode < 400) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    })
    .catch((result) => {
      log({
        Name: 'GoogleCustomerMatch',
        Type: 'Message',
        TraceId: traceId,
        EventName: logEventName,
        Message: 'Request failed or timed out.',
        Reason: JSON.stringify(result)
      });

      if (!useOptimisticScenario) data.gtmOnFailure();
    });
}

/*==============================================================================
  Helpers
==============================================================================*/

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function isSHA256Base64Hashed(value) {
  if (!value) return false;
  const valueStr = makeString(value);
  const base64Regex = '^[A-Za-z0-9+/]{43}=?$';
  return valueStr.match(base64Regex) !== null;
}

function isSHA256HexHashed(value) {
  if (!value) return false;
  const valueStr = makeString(value);
  const hexRegex = '^[A-Fa-f0-9]{64}$';
  return valueStr.match(hexRegex) !== null;
}

function hashData(value) {
  if (!value) return value;

  const type = getType(value);

  if (value === 'undefined' || value === 'null') return undefined;

  if (type === 'array') {
    return value.map((val) => hashData(val));
  }

  if (type === 'object') {
    return Object.keys(value).reduce((acc, val) => {
      acc[val] = hashData(value[val]);
      return acc;
    }, {});
  }

  if (isSHA256HexHashed(value) || isSHA256Base64Hashed(value)) return value;

  return sha256Sync(makeString(value).trim().toLowerCase(), {
    outputEncoding: 'hex'
  });
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function isConsentGivenOrNotRequired() {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  const bigquery =
    getType(BigQuery) === 'function' ? BigQuery() /* Only during Unit Tests */ : BigQuery;
  bigquery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-gtm-identifier"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-gtm-default-domain"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-gtm-api-key"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://datamanager.googleapis.com/*"
              },
              {
                "type": 1,
                "string": "https://*.stape.io/*"
              },
              {
                "type": 1,
                "string": "https://*.stape.net/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[Single User] Should NOT send request if Audience Members list is empty'
  code: |-
    setMockDataByAudienceMethod('ingest', {
      userMode: 'single',
      userDataEmailAddresses: undefined,
      userDataPhoneNumbers: undefined,
      addUserDataAddress: false,
      addressGivenName: undefined,
      addressFamilyName: undefined,
      addressRegion: undefined,
      addressPostalCode: undefined,
      mobileIds: undefined,
      pairIds: undefined,
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: '[Multiple Users] Should NOT send request if Audience Members list is empty'
  code: |
    setMockDataByAudienceMethod('ingest', {
      userMode: 'multiple',
      audienceMembers: undefined
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: '[Multiple Users] Should NOT send request if Audience Members list length
    is greater than 10000'
  code: |-
    // Not possible to test using the current version that doesn't support Mobile IDs and PAIR IDs.
    /*
    const audienceMembersSize = 10001;
    const audienceMembers = [
      {
        userData: {},
        pairData: {}
      }
    ];

    audienceMembers.length = 10001;

    setMockDataByAudienceMethod('ingest', {
      userMode: 'multiple',
      audienceMembers: audienceMembers
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    */
- name: '[Ingest] Request URL is succesfully built based on Audience Method'
  code: "setMockDataByAudienceMethod('ingest');\n\nmock('sendHttpRequest', (requestUrl,\
    \ callback, requestOptions, requestBody) => {\n  assertThat(requestUrl).isEqualTo('https://expectedXGtmIdentifier.expectedXGtmDefaultDomain/stape-api/expectedXGtmApiKey/v2/data-manager/ingest');\n\
    \  if (typeof callback === 'function') {\n    callback(200);\n  } else {\n   \
    \ requestBody = requestOptions;\n    requestOptions = callback;\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nrunCode(mockData);\n\
    \ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Remove] Request URL is succesfully built based on Audience Method'
  code: "setMockDataByAudienceMethod('remove');\n\nmock('sendHttpRequest', (requestUrl,\
    \ callback, requestOptions, requestBody) => {\n  assertThat(requestUrl).isEqualTo('https://expectedXGtmIdentifier.expectedXGtmDefaultDomain/stape-api/expectedXGtmApiKey/v2/data-manager/remove');\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: Request Options are succesfully built and sent in the request
  code: "setMockDataByAudienceMethod('ingest');\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  assertThat(requestOptions).isEqualTo({\n\
    \    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n\
    \    }\n  });\n\n  return Promise.create((resolve, reject) => {\n    resolve({\
    \ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Ingest - Single User] Request is successfully built and sent - data from
    UI fields'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'single'\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo({\n    destinations:\
    \ [\n      {\n        productDestinationId: 'stape_123',\n        operatingAccount:\
    \ { product: 'GOOGLE_ADS', accountId: '123' },\n        linkedAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '123' }\n      },\n      {\n        productDestinationId:\
    \ 'stape_444',\n        operatingAccount: { product: 'GOOGLE_ADS', accountId:\
    \ '444' },\n        linkedAccount: { product: 'GOOGLE_ADS', accountId: '444' }\n\
    \      }\n    ],\n    validateOnly: false,\n    termsOfService: { customerMatchTermsOfServiceStatus:\
    \ 'ACCEPTED' },\n    consent: {\n      adUserData: 'CONSENT_GRANTED',\n      adPersonalization:\
    \ 'CONSENT_GRANTED'\n    },\n    audienceMembers: [\n      {\n        userData:\
    \ {\n          userIdentifiers: [\n            {\n              emailAddress:\n\
    \                '973dfe463ec85785f5f95af5ba3906eedb2d931c24e69824a89ea65dba4e813b'\n\
    \            },\n            {\n              phoneNumber:\n                '910a625c4ba147b544e6bd2f267e130ae14c591b6ba9c25cb8573322dedbebd0'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'BR',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        }\n      },\n      { mobileData:\
    \ { mobileIds: ['AAA-BB-CC-111'] } },\n      {\n        pairData: {\n        \
    \  pairIds: [\n            '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363'\n\
    \          ]\n        }\n      }\n    ],\n    encoding: 'HEX',\n    encryptionInfo:\
    \ {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n    \
    \    wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Ingest - Single User] Request is successfully built and sent - data from
    UI fallbacks'
  code: "setGetAllEventData();\nsetMockDataByAudienceMethod('ingest', {\n  userMode:\
    \ 'single',\n  userDataEmailAddresses: undefined,\n  userDataPhoneNumbers: undefined,\n\
    \  addUserDataAddress: true,\n  enableAudienceDataEncryption: false,\n  mobileIds:\
    \ undefined,\n  pairIds: undefined\n});\n\n[\n  'userDataEmailAddresses',\n  'userDataPhoneNumbers',\n\
    \  'addressGivenName',\n  'addressFamilyName',\n  'addressRegion',\n  'addressPostalCode'\n\
    ].forEach((key) => Object.delete(mockData, key));\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  const parsedRequestBody = JSON.parse(requestBody);\n\
    \  assertThat(parsedRequestBody).isEqualTo({\n    destinations: [\n      {\n \
    \       productDestinationId: 'stape_123',\n        operatingAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '123' },\n        linkedAccount: { product: 'GOOGLE_ADS',\
    \ accountId: '123' }\n      },\n      {\n        productDestinationId: 'stape_444',\n\
    \        operatingAccount: { product: 'GOOGLE_ADS', accountId: '444' },\n    \
    \    linkedAccount: { product: 'GOOGLE_ADS', accountId: '444' }\n      }\n   \
    \ ],\n    validateOnly: false,\n    termsOfService: { customerMatchTermsOfServiceStatus:\
    \ 'ACCEPTED' },\n    consent: {\n      adUserData: 'CONSENT_GRANTED',\n      adPersonalization:\
    \ 'CONSENT_GRANTED'\n    },\n    audienceMembers: [\n      {\n        userData:\
    \ {\n          userIdentifiers: [\n            {\n              emailAddress:\n\
    \                'ddffdce54594d729a13068951750239a1943c295a5f89349b5cf69744d4a1ba2'\n\
    \            },\n            {\n              emailAddress:\n                'afea90f78a2e604dc6cc5d7826ffdd2bfbab612a0c1222acf8df173319b7e809'\n\
    \            },\n            {\n              phoneNumber:\n                'c698c0b85d32cbcf5033ada58f34de87d4f7415efaf5a8d1c1e9e63393dcc85e'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                postalCode: '10001',\n                regionCode: 'BR'\n    \
    \          }\n            }\n          ]\n        }\n      }\n    ],\n    encoding:\
    \ 'HEX'\n  });\n\n  return Promise.create((resolve, reject) => {\n    resolve({\
    \ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Ingest - Single User] data from UI fallbacks are not used when passing undefined
    to the fields'
  code: "setGetAllEventData();\nsetMockDataByAudienceMethod('ingest', {\n  userMode:\
    \ 'single',\n  userDataEmailAddresses: undefined,\n  userDataPhoneNumbers: undefined,\n\
    \  addUserDataAddress: true,\n  addressGivenName: undefined,\n  addressFamilyName:\
    \ undefined,\n  addressRegion: undefined,\n  addressPostalCode: undefined,\n \
    \ enableAudienceDataEncryption: false\n});\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  const parsedRequestBody = JSON.parse(requestBody);\n\
    \  assertThat(parsedRequestBody).isEqualTo({\n    destinations: [\n      {\n \
    \       productDestinationId: 'stape_123',\n        operatingAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '123' },\n        linkedAccount: { product: 'GOOGLE_ADS',\
    \ accountId: '123' }\n      },\n      {\n        productDestinationId: 'stape_444',\n\
    \        operatingAccount: { product: 'GOOGLE_ADS', accountId: '444' },\n    \
    \    linkedAccount: { product: 'GOOGLE_ADS', accountId: '444' }\n      }\n   \
    \ ],\n    validateOnly: false,\n    termsOfService: { customerMatchTermsOfServiceStatus:\
    \ 'ACCEPTED' },\n    consent: {\n      adUserData: 'CONSENT_GRANTED',\n      adPersonalization:\
    \ 'CONSENT_GRANTED'\n    },\n    audienceMembers: [\n      { mobileData: { mobileIds:\
    \ ['AAA-BB-CC-111'] } },\n      {\n        pairData: {\n          pairIds: [\n\
    \            '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363'\n\
    \          ]\n        }\n      }\n    ],\n    encoding: 'HEX'\n  });\n\n  return\
    \ Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200 });\n \
    \ });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Ingest - Multiple Users] Request is successfully built and sent - data from
    UI fields'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'multiple',\n  audienceMembers:\
    \ [\n    {\n      userData: {\n        userIdentifiers: [\n          {\n     \
    \       emailAddress:\n              '973dfe463ec85785f5f95af5ba3906eedb2d931c24e69824a89ea65dba4e813b'\n\
    \          },\n          {\n            phoneNumber:\n              '910a625c4ba147b544e6bd2f267e130ae14c591b6ba9c25cb8573322dedbebd0'\n\
    \          },\n          {\n            address: {\n              givenName:\n\
    \                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              familyName:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              regionCode: 'BR',\n              postalCode: '10001'\n        \
    \    }\n          }\n        ]\n      }\n    },\n    {\n      userData: {\n  \
    \      userIdentifiers: [\n          {\n            emailAddress:\n          \
    \    '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n    \
    \      },\n          {\n            phoneNumber:\n              '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n\
    \          },\n          {\n            address: {\n              givenName:\n\
    \                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              familyName:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              regionCode: 'US',\n              postalCode: '22222'\n        \
    \    }\n          }\n        ]\n      }\n    },\n    { \n      mobileData: { mobileIds:\
    \ ['AAA-BB-CC-111'] } \n    },\n    { \n      mobileData: { mobileIds: ['foobar',\
    \ 'barfoo'] } \n    },\n    {\n      pairData: { pairIds: ['426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363']\
    \ }\n    },\n    {\n      pairData: { pairIds: ['abc', 'cde'] }\n    }\n  ]\n\
    });\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo({\n\
    \    destinations: [\n      {\n        productDestinationId: 'stape_123',\n  \
    \      operatingAccount: { product: 'GOOGLE_ADS', accountId: '123' },\n      \
    \  linkedAccount: { product: 'GOOGLE_ADS', accountId: '123' }\n      },\n    \
    \  {\n        productDestinationId: 'stape_444',\n        operatingAccount: {\
    \ product: 'GOOGLE_ADS', accountId: '444' },\n        linkedAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '444' }\n      }\n    ],\n    validateOnly: false,\n\
    \    termsOfService: { customerMatchTermsOfServiceStatus: 'ACCEPTED' },\n    consent:\
    \ {\n      adUserData: 'CONSENT_GRANTED',\n      adPersonalization: 'CONSENT_GRANTED'\n\
    \    },\n    audienceMembers: [\n      {\n        userData: {\n          userIdentifiers:\
    \ [\n            {\n              emailAddress:\n                '973dfe463ec85785f5f95af5ba3906eedb2d931c24e69824a89ea65dba4e813b'\n\
    \            },\n            {\n              phoneNumber:\n                '910a625c4ba147b544e6bd2f267e130ae14c591b6ba9c25cb8573322dedbebd0'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'BR',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        }\n      },\n      {\n     \
    \   userData: {\n          userIdentifiers: [\n            {\n              emailAddress:\n\
    \                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n\
    \            },\n            {\n              phoneNumber:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'US',\n                postalCode: '22222'\n    \
    \          }\n            }\n          ]\n        }\n      }\n      // Mobile\
    \ IDs and PAIR IDs are not currently supported.\n    ],\n    encoding: 'HEX',\n\
    \    encryptionInfo: {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n\
    \        wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Remove - Single User] Request is successfully built and sent - data from
    UI fields'
  code: "setMockDataByAudienceMethod('remove', {\n  userMode: 'single'\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo({\n    destinations:\
    \ [\n      {\n        productDestinationId: 'stape_123',\n        operatingAccount:\
    \ { product: 'GOOGLE_ADS', accountId: '123' },\n        linkedAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '123' }\n      },\n      {\n        productDestinationId:\
    \ 'stape_444',\n        operatingAccount: { product: 'GOOGLE_ADS', accountId:\
    \ '444' },\n        linkedAccount: { product: 'GOOGLE_ADS', accountId: '444' }\n\
    \      }\n    ],\n    validateOnly: false,\n    audienceMembers: [\n      {\n\
    \        userData: {\n          userIdentifiers: [\n            {\n          \
    \    emailAddress:\n                '973dfe463ec85785f5f95af5ba3906eedb2d931c24e69824a89ea65dba4e813b'\n\
    \            },\n            {\n              phoneNumber:\n                '910a625c4ba147b544e6bd2f267e130ae14c591b6ba9c25cb8573322dedbebd0'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'BR',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        }\n      },\n      { mobileData:\
    \ { mobileIds: ['AAA-BB-CC-111'] } },\n      {\n        pairData: {\n        \
    \  pairIds: [\n            '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363'\n\
    \          ]\n        }\n      }\n    ],\n    encoding: 'HEX',\n    encryptionInfo:\
    \ {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n    \
    \    wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Remove - Single User] Request is successfully built and sent - data from
    UI fallbacks'
  code: "setGetAllEventData();\nsetMockDataByAudienceMethod('remove', {\n  userMode:\
    \ 'single',\n  userDataEmailAddresses: undefined,\n  userDataPhoneNumbers: undefined,\n\
    \  addUserDataAddress: true,\n  enableAudienceDataEncryption: false,\n  mobileIds:\
    \ undefined,\n  pairIds: undefined\n});\n\n[\n  'userDataEmailAddresses',\n  'userDataPhoneNumbers',\n\
    \  'addressGivenName',\n  'addressFamilyName',\n  'addressRegion',\n  'addressPostalCode'\n\
    ].forEach((key) => Object.delete(mockData, key));\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  const parsedRequestBody = JSON.parse(requestBody);\n\
    \  assertThat(parsedRequestBody).isEqualTo({\n    destinations: [\n      {\n \
    \       productDestinationId: 'stape_123',\n        operatingAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '123' },\n        linkedAccount: { product: 'GOOGLE_ADS',\
    \ accountId: '123' }\n      },\n      {\n        productDestinationId: 'stape_444',\n\
    \        operatingAccount: { product: 'GOOGLE_ADS', accountId: '444' },\n    \
    \    linkedAccount: { product: 'GOOGLE_ADS', accountId: '444' }\n      }\n   \
    \ ],\n    validateOnly: false,\n    audienceMembers: [\n      {\n        userData:\
    \ {\n          userIdentifiers: [\n            {\n              emailAddress:\n\
    \                'ddffdce54594d729a13068951750239a1943c295a5f89349b5cf69744d4a1ba2'\n\
    \            },\n            {\n              emailAddress:\n                'afea90f78a2e604dc6cc5d7826ffdd2bfbab612a0c1222acf8df173319b7e809'\n\
    \            },\n            {\n              phoneNumber:\n                'c698c0b85d32cbcf5033ada58f34de87d4f7415efaf5a8d1c1e9e63393dcc85e'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                postalCode: '10001',\n                regionCode: 'BR'\n    \
    \          }\n            }\n          ]\n        }\n      }\n    ],\n    encoding:\
    \ 'HEX'\n  });\n\n  return Promise.create((resolve, reject) => {\n    resolve({\
    \ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Remove - Single User] data from UI fallbacks are not used when passing undefined
    to the fields'
  code: "setGetAllEventData();\nsetMockDataByAudienceMethod('remove', {\n  userMode:\
    \ 'single',\n  userDataEmailAddresses: undefined,\n  userDataPhoneNumbers: undefined,\n\
    \  addUserDataAddress: true,\n  addressGivenName: undefined,\n  addressFamilyName:\
    \ undefined,\n  addressRegion: undefined,\n  addressPostalCode: undefined,\n \
    \ enableAudienceDataEncryption: false\n});\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  const parsedRequestBody = JSON.parse(requestBody);\n\
    \  assertThat(parsedRequestBody).isEqualTo({\n    destinations: [\n      {\n \
    \       productDestinationId: 'stape_123',\n        operatingAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '123' },\n        linkedAccount: { product: 'GOOGLE_ADS',\
    \ accountId: '123' }\n      },\n      {\n        productDestinationId: 'stape_444',\n\
    \        operatingAccount: { product: 'GOOGLE_ADS', accountId: '444' },\n    \
    \    linkedAccount: { product: 'GOOGLE_ADS', accountId: '444' }\n      }\n   \
    \ ],\n    validateOnly: false,\n    audienceMembers: [\n      { mobileData: {\
    \ mobileIds: ['AAA-BB-CC-111'] } },\n      {\n        pairData: {\n          pairIds:\
    \ [\n            '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363'\n\
    \          ]\n        }\n      }\n    ],\n    encoding: 'HEX'\n  });\n\n  return\
    \ Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200 });\n \
    \ });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Remove - Multiple Users] Request is successfully built and sent - data from
    UI fields'
  code: "setMockDataByAudienceMethod('remove', {\n  userMode: 'multiple',\n  audienceMembers:\
    \ [\n    {\n      userData: {\n        userIdentifiers: [\n          {\n     \
    \       emailAddress:\n              '973dfe463ec85785f5f95af5ba3906eedb2d931c24e69824a89ea65dba4e813b'\n\
    \          },\n          {\n            phoneNumber:\n              '910a625c4ba147b544e6bd2f267e130ae14c591b6ba9c25cb8573322dedbebd0'\n\
    \          },\n          {\n            address: {\n              givenName:\n\
    \                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              familyName:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              regionCode: 'BR',\n              postalCode: '10001'\n        \
    \    }\n          }\n        ]\n      }\n    },\n    {\n      userData: {\n  \
    \      userIdentifiers: [\n          {\n            emailAddress:\n          \
    \    '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n    \
    \      },\n          {\n            phoneNumber:\n              '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n\
    \          },\n          {\n            address: {\n              givenName:\n\
    \                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              familyName:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              regionCode: 'US',\n              postalCode: '22222'\n        \
    \    }\n          }\n        ]\n      }\n    },\n    { \n      mobileData: { mobileIds:\
    \ ['AAA-BB-CC-111'] } \n    },\n    { \n      mobileData: { mobileIds: ['foobar',\
    \ 'barfoo'] } \n    },\n    {\n      pairData: { pairIds: ['426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363']\
    \ }\n    },\n    {\n      pairData: { pairIds: ['abc', 'cde'] }\n    }\n  ]\n\
    });\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo({\n\
    \    destinations: [\n      {\n        productDestinationId: 'stape_123',\n  \
    \      operatingAccount: { product: 'GOOGLE_ADS', accountId: '123' },\n      \
    \  linkedAccount: { product: 'GOOGLE_ADS', accountId: '123' }\n      },\n    \
    \  {\n        productDestinationId: 'stape_444',\n        operatingAccount: {\
    \ product: 'GOOGLE_ADS', accountId: '444' },\n        linkedAccount: { product:\
    \ 'GOOGLE_ADS', accountId: '444' }\n      }\n    ],\n    validateOnly: false,\n\
    \    audienceMembers: [\n      {\n        userData: {\n          userIdentifiers:\
    \ [\n            {\n              emailAddress:\n                '973dfe463ec85785f5f95af5ba3906eedb2d931c24e69824a89ea65dba4e813b'\n\
    \            },\n            {\n              phoneNumber:\n                '910a625c4ba147b544e6bd2f267e130ae14c591b6ba9c25cb8573322dedbebd0'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'BR',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        }\n      },\n      {\n     \
    \   userData: {\n          userIdentifiers: [\n            {\n              emailAddress:\n\
    \                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n\
    \            },\n            {\n              phoneNumber:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'US',\n                postalCode: '22222'\n    \
    \          }\n            }\n          ]\n        }\n      }\n      // Mobile\
    \ IDs and PAIR IDs are not currently supported.\n    ],\n    encoding: 'HEX',\n\
    \    encryptionInfo: {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n\
    \        wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Hex] Encoding is correctly defined when hashed Audience Data is already
    Hex encoded'
  code: "setGetAllEventData();\nsetMockDataByAudienceMethod('ingest', {\n  userMode:\
    \ 'single',\n  audienceDataEncoding: undefined,\n  userDataEmailAddresses: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  userDataPhoneNumbers: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  addUserDataAddress: true,\n  addressGivenName: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  addressFamilyName: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  pairIds: ['426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363']\n\
    });\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody.encoding).isEqualTo('HEX');\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Base64] Encoding is correctly defined when hashed Audience Data is already
    Base64 encoded'
  code: "setGetAllEventData();\nsetMockDataByAudienceMethod('ingest', {\n  userMode:\
    \ 'single',\n  audienceDataEncoding: undefined,\n  userDataEmailAddresses: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n\
    \  userDataPhoneNumbers: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n  addUserDataAddress:\
    \ true,\n  addressGivenName: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n\
    \  addressFamilyName: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n  pairIds:\
    \ ['osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=']\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody.encoding).isEqualTo('BASE64');\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: Should log to console, if the 'Always log to console' option is selected
  code: "setMockDataByAudienceMethod('ingest');\nmockData.logType = 'always';\n\n\
    const expectedDebugMode = true;\nmock('getContainerVersion', () => {\n  return\
    \ {\n    debugMode: expectedDebugMode\n  };\n}); \n\nmock('logToConsole', (logData)\
    \ => {\n  const parsedLogData = JSON.parse(logData);\n  requiredConsoleKeys.forEach(p\
    \ => assertThat(parsedLogData[p]).isDefined());\n});\n\nrunCode(mockData);\n\n\
    callLater(() => {\n  assertApi('logToConsole').wasCalled();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: Should log to console, if the 'Log during debug and preview' option is selected
    AND is on preview mode
  code: |-
    setMockDataByAudienceMethod('ingest');
    mockData.logType = 'debug';

    const expectedDebugMode = true;
    mock('getContainerVersion', () => {
      return {
        debugMode: expectedDebugMode
      };
    });

    mock('logToConsole', (logData) => {
      const parsedLogData = JSON.parse(logData);
      requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());
    });

    runCode(mockData);

    callLater(() => {
      assertApi('logToConsole').wasCalled();
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();
    });
- name: Should NOT log to console, if the 'Log during debug and preview' option is
    selected AND is NOT on preview mode
  code: "setMockDataByAudienceMethod('ingest');\nmockData.logType = 'debug';\n\nconst\
    \ expectedDebugMode = false;\nmock('getContainerVersion', () => {\n  return {\n\
    \    debugMode: expectedDebugMode\n  };\n}); \n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('logToConsole').wasNotCalled();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: Should NOT log to console, if the 'Do not log' option is selected
  code: |-
    setMockDataByAudienceMethod('ingest');
    mockData.logType = 'no';

    runCode(mockData);

    callLater(() => {
      assertApi('logToConsole').wasNotCalled();
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();
    });
- name: Should log to BQ, if the 'Log to BigQuery' option is selected
  code: "setMockDataByAudienceMethod('ingest');\nmockData.bigQueryLogType = 'always';\n\
    \n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mock('BigQuery', () => {\n  return { \n    insert: (connectionInfo, rows, options)\
    \ => { \n      assertThat(connectionInfo).isDefined();\n      assertThat(rows).isArray();\n\
    \      assertThat(rows).hasLength(1);\n      requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \      assertThat(options).isEqualTo(expectedBqOptions);\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nrunCode(mockData);\n\
    \ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: Should NOT log to BQ, if the 'Do not log to BigQuery' option is selected
  code: "setMockDataByAudienceMethod('ingest');\nmockData.bigQueryLogType = 'no';\n\
    \n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mock('BigQuery', () => {\n  return { \n    insert: (connectionInfo, rows, options)\
    \ => { \n      fail('BigQuery.insert should not have been called.');\n      return\
    \ Promise.create((resolve, reject) => {\n        resolve();\n      });\n    }\n\
    \  };\n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
setup: "const Promise = require('Promise');\nconst JSON = require('JSON');\nconst\
  \ makeInteger = require('makeInteger');\nconst Object = require('Object');\nconst\
  \ callLater = require('callLater');\n\nconst mergeObj = (target, source) => {\n\
  \  for (const key in source) {\n    if (source.hasOwnProperty(key)) target[key]\
  \ = source[key];\n  }\n  return target;\n};\n\nconst expectedBigQuerySettings =\
  \ {\n  logBigQueryProjectId: 'logBigQueryProjectId',\n  logBigQueryDatasetId: 'logBigQueryDatasetId',\n\
  \  logBigQueryTableId: 'logBigQueryTableId'\n};\n\nconst requiredConsoleKeys = ['Type',\
  \ 'TraceId', 'Name'];\nconst requiredBqKeys = ['timestamp', 'type', 'trace_id',\
  \ 'tag_name'];\nconst expectedBqOptions = { ignoreUnknownValues: true };\n\nconst\
  \ mockData = {\n  logBigQueryProjectId: expectedBigQuerySettings.logBigQueryProjectId,\n\
  \  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n  logBigQueryTableId:\
  \ expectedBigQuerySettings.logBigQueryTableId\n};\n\nconst setMockDataByAudienceMethod\
  \ = (method, objToBeMerged) => {\n  const methods = {\n    ingest: {\n      audienceAction:\
  \ 'ingest',\n      authFlow: 'stape',\n      stapeAuthDestinationsList: [\n    \
  \  {\n          product: 'GOOGLE_ADS',\n          operatingAccountId: '123',\n \
  \         linkedAccountId: '123',\n          productDestinationId: '123'\n     \
  \   },\n        {\n          product: 'GOOGLE_ADS',\n          operatingAccountId:\
  \ '444',\n          linkedAccountId: '444',\n          productDestinationId: '444'\n\
  \        }\n      ],\n      termsOfServiceStatus: 'ACCEPTED',\n      validateOnly:\
  \ false,\n      useOptimisticScenario: false,\n      adUserData: 'CONSENT_GRANTED',\n\
  \      adPersonalization: 'CONSENT_GRANTED',\n      audienceDataEncoding: 'HEX',\n\
  \      enableAudienceDataEncryption: true,\n      gcpWrappedKeyType: 'XCHACHA20_POLY1305',\n\
  \      gcpWrappedKeyEncryptedDek: '123',\n      gcpWrappedKeyKekUri: '123',\n  \
  \    gcpWrappedKeyWipProvider: '123',\n      userMode: 'single',\n      userDataEmailAddresses:\
  \ 'test@example.com',\n      userDataPhoneNumbers: '+15555555555',\n      addUserDataAddress:\
  \ true,\n      addressGivenName: 'test',\n      addressFamilyName: 'test',\n   \
  \   addressRegion: 'BR',\n      addressPostalCode: '10001',\n      mobileIds: 'AAA-BB-CC-111',\n\
  \      pairIds: 'foobar123',\n      adStorageConsent: 'optional',\n      logType:\
  \ 'debug',\n      bigQueryLogType: 'no'\n    },\n    remove: {\n      audienceAction:\
  \ 'remove',\n      authFlow: 'stape',\n      stapeAuthDestinationsList: [\n    \
  \  {\n          product: 'GOOGLE_ADS',\n          operatingAccountId: '123',\n \
  \         linkedAccountId: '123',\n          productDestinationId: '123'\n     \
  \   },\n        {\n          product: 'GOOGLE_ADS',\n          operatingAccountId:\
  \ '444',\n          linkedAccountId: '444',\n          productDestinationId: '444'\n\
  \        }\n      ],\n      validateOnly: false,\n      useOptimisticScenario: false,\n\
  \      audienceDataEncoding: 'HEX',\n      enableAudienceDataEncryption: true,\n\
  \      gcpWrappedKeyType: 'XCHACHA20_POLY1305',\n      gcpWrappedKeyEncryptedDek:\
  \ '123',\n      gcpWrappedKeyKekUri: '123',\n      gcpWrappedKeyWipProvider: '123',\n\
  \      userMode: 'single',\n      userDataEmailAddresses: 'test@example.com',\n\
  \      userDataPhoneNumbers: '+15555555555',\n      addUserDataAddress: true,\n\
  \      addressGivenName: 'test',\n      addressFamilyName: 'test',\n      addressRegion:\
  \ 'BR',\n      addressPostalCode: '10001',\n      mobileIds: 'AAA-BB-CC-111',\n\
  \      pairIds: 'foobar123',\n      adStorageConsent: 'optional',\n      logType:\
  \ 'debug',\n      bigQueryLogType: 'no'\n    }\n  };\n  \n  return mergeObj(\n \
  \   mockData, \n    mergeObj(methods[method], objToBeMerged || {})\n  );\n};\n\n\
  const setGetAllEventData = (objToBeMerged) => {\n  mock('getAllEventData', mergeObj({\n\
  \    'x-ga-protocol_version': '2',\n    'x-ga-measurement_id': 'G-123ABC',\n   \
  \ 'x-ga-gtm_version': '45je55e1za200',\n    'x-ga-page_id': 1747422523211,\n   \
  \ 'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa': '0',\n    'x-ga-dma': '0',\n    'x-ga-mp2-tag_exp':\n\
  \      '101509157~103116025~103130498~103130500~103136993~103136995~103200001~103207802~103211513~103233427~103252644~103252646~103263073~103301114~103301116',\n\
  \    client_id: 'AUJctU7H7hBB/aMuhE4pKwGu5DWDdklg5abyyyn8i/I=.1747154479',\n   \
  \ 'x-ga-ecid': '1294673677',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    event_id: '101509157~103116025~103130498',\n\
  \    timestamp: 1748377016,\n    client_hints: {\n      architecture: 'arm',\n \
  \     bitness: '64',\n      full_version_list: [\n        { brand: 'Chromium', version:\
  \ '136.0.7103.93' },\n        { brand: 'Google Chrome', version: '136.0.7103.93'\
  \ },\n        { brand: 'Not.A/Brand', version: '99.0.0.0' }\n      ],\n      mobile:\
  \ false,\n      model: '',\n      platform: 'macOS',\n      platform_version: '15.2.0',\n\
  \      wow64: false,\n      brands: [\n        { brand: 'Chromium', version: '136'\
  \ },\n        { brand: 'Google Chrome', version: '136' },\n        { brand: 'Not.A/Brand',\
  \ version: '99' }\n      ]\n    },\n    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n\
  \    'x-ga-pscdl': 'noapi',\n    'x-ga-system_properties': { eu: [34], tu: 'BA',\
  \ ss: '1', ee: true },\n    'x-sst-system_properties': {\n      etld: 'google.com.br',\n\
  \      tft: '1747422523211',\n      lpc: '60493049',\n      navt: 'r',\n      ude:\
  \ '0',\n      sw_exp: '1',\n      request_start_time_ms: 1747422524851\n    },\n\
  \    'x-ga-request_count': 1,\n    ga_session_id: '1747422523',\n    ga_session_number:\
  \ 3,\n    'x-ga-mp2-seg': '0',\n    page_location: 'https://example.com/?test=1i23i21j3',\n\
  \    page_title: 'Example Domain',\n    event_name: 'page_view',\n    'x-ga-tfd':\
  \ 5784,\n    ip_override: '2804:14d:c096:8dd6:311c:8c00:e6c:e33',\n    user_agent:\n\
  \      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML,\
  \ like Gecko) Chrome/136.0.0.0 Safari/537.36',\n    value: 123.45,\n    currency:\
  \ 'BRL',\n    user_data: {\n      email: { 0: 'test1@example.net', 1: 'test2@example.org'\
  \ },\n      phone_number: '+55 (19) 99999-9999',\n      address: {\n        first_name:\
  \ 'test',\n        last_name: 'test',\n        postal_code: '10001',\n        country:\
  \ 'BR'\n      }\n    }\n  }, objToBeMerged || {}));\n};\n\nmock('sendHttpRequest',\
  \ (requestUrl, callback, requestOptions, requestBody) => {\n  if (typeof callback\
  \ === 'function') {\n    callback(200);\n  } else {\n    requestBody = requestOptions;\n\
  \    requestOptions = callback;\n    return Promise.create((resolve, reject) =>\
  \ {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nmock('getRequestHeader',\
  \ (header) => {\n  if (header === 'trace-id') return 'expectedTraceId';\n  else\
  \ if (header === 'x-gtm-identifier') return 'expectedXGtmIdentifier';\n  else if\
  \ (header === 'x-gtm-default-domain') return 'expectedXGtmDefaultDomain';\n  else\
  \ if (header === 'x-gtm-api-key') return 'expectedXGtmApiKey';\n});\n\nmock('getTimestampMillis',\
  \ 1747945830456);"


___NOTES___

Created on 7/9/2025, 6:32:40 PM

